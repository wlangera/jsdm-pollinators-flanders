---
title: "Preparation of trait and phylogenetic data"
author: "Ward Langeraert"
date: today
date-format: "D MMMM YYYY"
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
editor_options: 
  chunk_output_type: console
---

# Goal

Load and prepare the trait and phylogenetic data in `data/raw` folder.

```{r}
#| warning: false
#| message: false
# Packages
library(tidyverse)

# Conflicts
conflicted::conflicts_prefer(dplyr::filter)

# Paths
data_path <- here::here("data", "raw")
out_path <- here::here("data", "intermediate")
```

# Trait data
## Load data

We load the trait data.

```{r}
trait_data_raw <- read_csv2(file.path(data_path,
                                      "traits_bestuivers_finaal.csv"),
                            show_col_types = FALSE)
```

We load the species list.

```{r}
species_list <- read_csv(file.path(out_path, "species_list.csv"),
                         show_col_types = FALSE)
```

## Join taxonomic data

We add taxonomic information to the trait dataset so that it can be merged easily with the observation dataset based on GBIF ID or species name.
We remove trait data for species not in the interim species list.

```{r}
trait_data_full <- trait_data_raw %>%
  select(-species, -genus) %>%
  inner_join(species_list, by = join_by(GBIF.ID == gbifID))
```

## Data preparation

```{r}
trait_data <- trait_data_full[, -1] %>%
  mutate(
    pollinatorGroup = ifelse(
      Bestuiversgroep == "macro-nachtvlinders", "nachtvlinders", Bestuiversgroep
    )
  ) %>%
  select(
    # Taxonomic information
    gbifID = GBIF.ID,
    species, pollinatorGroup, genus, family, order, class, phylum, class,
    redListCategory = Rodelijst,
    verbatimRedListCategory = RodeLijstCategorie,
    # Traits
    larvalFoodSource = voedsel_larven,
    larvalFeedingSpecialisation = specialisatie_larven,
    reproductiveHabitat = voortplantingshabitat,
    hostPlantType = waardplanten,
    adultFeedingSpecialisation = specialisatie_adult,
    isHabitatGeneralist = habitat_generalist,
    forestAffinity = bos,
    grasslandAffinity = grasland,
    wetlandAffinity = moeras,
    croplandAffinity = akker,
    urbanAffinity = urbaan,
    heathlandAffinity = heide,
    freshwaterAffinity = `zoet water`,
    brackishAffinity = brakke_zilte_milieus,
    coastalAffinity = duinen_strand,
    temperatureMin = Temp_min,
    temperatureMax = Temp_max,
    temperatureMean = Temp_mean,
    temperatureQuantiles = quantiles,
    temperaturePreference = Tvoorkeur,
    bodyLength = lichaamslengte,
    voltinismMean = Voltinism_mean,
    voltinismMaxCategory = Voltinism_max,
    fecundity = Fecundity,
    lifespanDays = Lifespan,
    developmentTimeDays = Development_time,
    flightPeriod = FlightPeriod,
    migrationBehaviour = Migration,
    habitatHumidityPreference = HabitatHumidity,
    # Extra
    traitRemarks = Opmerkingen,
    ecosystemRemarks = opmerkingen_ecosystemen
  )
```

## Write out data

```{r}
write_csv(trait_data, file.path(out_path, "trait_data_interim.csv"))
```
